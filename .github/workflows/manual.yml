name: Weekly Algorithm Report
on:
  schedule:
    - cron: '5 15 * * 0' # ë§¤ì£¼ ì›”ìš”ì¼ 0ì‹œ 5ë¶„ (UTC ì¼ìš”ì¼ 15:05, í•œêµ­ì€ +9h)
  workflow_dispatch:
jobs:
  count-submissions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Count submissions
        id: count
        run: |
          # í•œêµ­ ì‹œê°„ëŒ€ ì„¤ì •
          export TZ=Asia/Seoul

          # ì´ë²ˆ ì£¼ ì›”ìš”ì¼ ì°¾ê¸°
          today=$(date +%Y-%m-%d)
          day_of_week=$(date -d "$today" +%u)  # 1=ì›”ìš”ì¼, 7=ì¼ìš”ì¼

          # ì§€ë‚œ ì£¼ ì›”ìš”ì¼ ê³„ì‚°
          # ì´ë²ˆ ì£¼ ì›”ìš”ì¼ì—ì„œ 7ì¼ì„ ë¹¼ë©´ ì§€ë‚œ ì£¼ ì›”ìš”ì¼
          days_since_monday=$((day_of_week - 1))
          this_monday=$(date -d "$today -$days_since_monday days" +%Y-%m-%d)
          last_week_start=$(date -d "$this_monday -7 days" +%Y-%m-%d)

          # ì§€ë‚œ ì£¼ ì›”~ì¼ ë‚ ì§œ ë°°ì—´
          dates_last_week=()
          for i in {0..6}; do
            dates_last_week+=($(date -d "$last_week_start +$i day" +%y%m%d))
          done

          # ì§€ì§€ë‚œ ì£¼ ì›”~ì¼ ë‚ ì§œ ê³„ì‚° (2ì£¼ ì—°ì† ë¯¸ì œì¶œ ì²´í¬ìš©)
          two_weeks_ago_start=$(date -d "$last_week_start -7 days" +%Y-%m-%d)
          dates_two_weeks_ago=()
          for i in {0..6}; do
            dates_two_weeks_ago+=($(date -d "$two_weeks_ago_start +$i day" +%y%m%d))
          done

          # ë³´ê¸° ì¢‹ì€ ê¸°ê°„ ë¬¸ìì—´ (ì˜ˆ: 1/6 ~ 1/12)
          period_start=$(date -d "$last_week_start" +%-m/%-d)
          period_end=$(date -d "$last_week_start +6 day" +%-m/%-d)

          # exclude.ymlì—ì„œ ì œì™¸í•  ë””ë ‰í† ë¦¬ ëª©ë¡ ì½ê¸°
          exclude_list=$(grep -A 100 "^exclude:" exclude.yml | grep "^  - " | sed 's/^  - //' | tr '\n' '|' | sed 's/|$//')

          # ì„ì‹œ íŒŒì¼ì— ì‚¬ìš©ìë³„ ì œì¶œ íšŸìˆ˜ ì €ì¥
          temp_file=$(mktemp)
          two_week_zero_file=$(mktemp)

          # ê° ì‚¬ìš©ì ë””ë ‰í† ë¦¬ íƒìƒ‰
          for user_dir in $(find . -mindepth 1 -maxdepth 1 -type d ! -name ".git" ! -name ".github"); do
            user=$(basename "$user_dir")

            # exclude.ymlì— ìˆëŠ” ë””ë ‰í† ë¦¬ ì œì™¸
            if [[ "$user" =~ ^($exclude_list)$ ]]; then
              continue
            fi

            # ì§€ë‚œ ì£¼ ì œì¶œ íšŸìˆ˜
            count_last_week=0
            for d in "${dates_last_week[@]}"; do
              if [[ -f "$user_dir/$d.md" ]]; then
                count_last_week=$((count_last_week+1))
              fi
            done

            # ì§€ì§€ë‚œ ì£¼ ì œì¶œ íšŸìˆ˜
            count_two_weeks_ago=0
            for d in "${dates_two_weeks_ago[@]}"; do
              if [[ -f "$user_dir/$d.md" ]]; then
                count_two_weeks_ago=$((count_two_weeks_ago+1))
              fi
            done

            echo "${user}: ${count_last_week}íšŒ" >> "$temp_file"

            # 2ì£¼ ì—°ì† 0íšŒ ì œì¶œì ì²´í¬
            if [[ $count_last_week -eq 0 ]] && [[ $count_two_weeks_ago -eq 0 ]]; then
              echo "${user}" >> "$two_week_zero_file"
            fi
          done

          # ì‚¬ì „ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ìµœì¢… ë³´ê³ ì„œ ìƒì„±
          {
            echo "${period_start} ~ ${period_end} ì•Œê³ ë¦¬ì¦˜ ì œì¶œ ê¸°ë¡"
            echo ""
            sort "$temp_file"
            echo ""

            # 2ì£¼ ì—°ì† ë¯¸ì œì¶œì í‘œì‹œ
            echo "2ì£¼ ì—°ì† ë¯¸ì œì¶œì:"
            if [[ -s "$two_week_zero_file" ]]; then
              # ì½¤ë§ˆë¡œ êµ¬ë¶„ëœ ëª©ë¡ ìƒì„±
              two_week_list=$(sort "$two_week_zero_file" | tr '\n' ',' | sed 's/,/, /g' | sed 's/, $//')
              echo "  - ${two_week_list}"
            else
              echo "  - X"
            fi
            echo ""

            echo "ì§€ë‚œ ì£¼ ì œì¶œ íšŸìˆ˜ì…ë‹ˆë‹¤."
            echo ""
            echo "ì œì¶œí•˜ì§€ ì•Šì€ ë¶„ì€ ë²Œê¸ˆ 2000ì›ì„ ì†¡ê¸ˆ í›„ ì²´í¬âœ… í‘œì‹œë¥¼ í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."
            echo "ì œì¶œí•œ ë¶„ì€ ì´ ë©”ì‹œì§€ì— ì¢‹ì•„ìš”ğŸ‘ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”."
          } > report.txt

          # ì„ì‹œ íŒŒì¼ ì •ë¦¬
          rm "$temp_file" "$two_week_zero_file"
          
          # ë³´ê³ ì„œ ë‚´ìš©ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì • (ë©€í‹°ë¼ì¸ ì²˜ë¦¬)
          {
            echo 'REPORT_CONTENT<<EOF'
            cat report.txt
            echo EOF
          } >> $GITHUB_ENV
          
          # ì½˜ì†”ì—ë„ ì¶œë ¥
          cat report.txt
          
      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Weekly Algorithm Study Report"
          body: ${{ env.REPORT_CONTENT }}
          to: kihong2424@gmail.com
          from: "Algorithm Bot <${{ secrets.EMAIL_USERNAME }}>"
