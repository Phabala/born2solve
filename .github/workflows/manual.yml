name: Weekly Algorithm Report

on:
  schedule:
    - cron: '5 15 * * 5' # ë§¤ì£¼ í† ìš”ì¼ 0ì‹œ 5ë¶„ (UTC+0 ê¸°ì¤€, í•œêµ­ì€ +9h â†’ 15ì‹œ)
  workflow_dispatch:

jobs:
  count-submissions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Count submissions
        run: |
          # ì˜¤ëŠ˜ ë‚ ì§œ(í† ìš”ì¼) ê¸°ì¤€ìœ¼ë¡œ ì§€ë‚œ ì›”~ê¸ˆ ë‚ ì§œ ê³„ì‚°
          start_date=$(date -d "last monday -7 days" +%Y-%m-%d)
          dates=()
          for i in {0..4}; do
            dates+=($(date -d "$start_date +$i day" +%y%m%d))
          done

          # ë³´ê¸° ì¢‹ì€ ê¸°ê°„ ë¬¸ìžì—´ (ì˜ˆ: 8/11 ~ 8/15)
          period_start=$(date -d "$start_date" +%-m/%-d)
          period_end=$(date -d "$start_date +4 day" +%-m/%-d)

          {
            echo "${period_start} ~ ${period_end} ì•Œê³ ë¦¬ì¦˜ ì œì¶œ ê¸°ë¡"
            echo ""
          } > report.txt

          # ê° ì‚¬ìš©ìž ë””ë ‰í† ë¦¬ íƒìƒ‰
          for user_dir in $(find . -mindepth 1 -maxdepth 1 -type d ! -name ".git" ! -name ".github"); do
            user=$(basename "$user_dir")
            count=0
            for d in "${dates[@]}"; do
              if [[ -f "$user_dir/$d.md" ]]; then
                count=$((count+1))
              fi
            done
            echo "${user}: ${count}íšŒ" >> report.txt
          done

          {
            echo ""
            echo "ì´ë²ˆ ì£¼ ì œì¶œ íšŸìˆ˜ìž…ë‹ˆë‹¤."
            echo "day-off, ê³µíœ´ì¼ì„ ì œì™¸í•˜ê³  ë‚¼ ë²Œê¸ˆì´ ì—†ëŠ” ë¶„ì€ ì´ ë©”ì‹œì§€ì— ì¢‹ì•„ìš”ðŸ‘, ìžˆëŠ” ë¶„ì€ ì†¡ê¸ˆ í›„ ì²´í¬â˜‘ï¸ í‘œì‹œë¥¼ í•´ì£¼ì‹œê¸° ë°”ëžë‹ˆë‹¤."
          } >> report.txt

          cat report.txt

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Weekly Algorithm Study Report"
          body: |
            $(cat report.txt)
          to: kihong2424@gmail.com
          from: "Algorithm Bot <${{ secrets.EMAIL_USERNAME }}>"

